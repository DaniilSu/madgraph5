#!/usr/bin/perl -w
&writeHtmlProcessPage;


sub writeHtmlProcessPage {
  my($interaction, $qcdOrder, $qedOrder);
  #
  #    Make sure we are in the main directory, not bin
  #
  if (-d "bin") {
    #      print "We are in main directory \n";
  } else {
    #      print "Not in correct directory \n";
    chdir("../");
    if (-d "bin") {
      #	  print "We are in main directory \n";
    } else {
      print "Error gen_infohtml-pl must be run from main or bin directory \n";
      exit;
    }	  
  }  
  #
  #	Writes out html page index.html with links to results
  #	and code.
  #
  my $totdiag=0;
  $htfile =  "HTML/info" . "\.html"; #name the file
  open(PAGE,"> $htfile");
  print PAGE "\<HTML\> \n";
  print PAGE "\<HEAD\> \n";
  print PAGE "\<TITLE\>  \<\/TITLE\> \n";
  if (! -e "SubProcesses/done") {
    print PAGE "<META HTTP-EQUIV=\"REFRESH\" CONTENT=\"30\" > \n";
  }
  print PAGE "<META HTTP-EQUIV=\"EXPIRES\" CONTENT=\"20\" >";
  print PAGE "\<\/HEAD\> \n";
  print PAGE "\<BODY\> \n";
  if (-e "SubProcesses/subproc.mg") {
    chdir("./SubProcesses");

      print PAGE "<P> <H2 ALIGN=CENTER> SubProcesses and Feynman diagrams <\/H2>";
    print PAGE "<TABLE BORDER=2 ALIGN=CENTER> \n";	
    print PAGE "<TR>";	
    print PAGE "<TH>Directory</TH> <TH NOWRAP># Diagrams </TH><TH NOWRAP># Subprocesses </TH> \n";
    print PAGE "<TH>FEYNMAN DIAGRAMS</TH> <TH> SUBPROCESS </TH></TR> \n";
    print PAGE "</TR>";	
    my($line);
    my($proc);
    my($after);
    my($before);
    $line= "Failed";
    if (open FILE, "subproc.mg") {
      while ($line = <FILE>) {
	chomp $line;
	print PAGE "<TR> <TD> $line </TD> \n";
	my $diagrams = 0;
	my @processes;
	$imatrix = "";
	if (! -e "$line/matrix.f") {$imatrix = 1;}
	while ( -e "$line/matrix$imatrix.f"){
	  if (open FILE2, "$line/matrix$imatrix.f") {
	    @lines = <FILE2>;
	    @tlines = grep /diagram number/, @lines;
	    $diagrams += $#tlines + 1;
	    close(FILE2);
	  }
	  if ((! -e "$line/processes.dat") and
	      (open FILE2, "$line/auto_dsig$imatrix.f")) {
	    @lines = <FILE2>;
	    @tlines = grep /IPROC=IPROC/, @lines; 	       
	    foreach $one (@tlines) {
	      ($before,$after) = split /!/,$one;
	      #		   print "$after \n ";
	      push (@processes, $after);
	    }
	    close(FILE2);
	  }
	  if ($imatrix eq "") {$imatrix = 0;}
	  $imatrix += 1;
	} # end while
	$totdiag += $diagrams;
	if (open FILE2, "$line/processes.dat") {
	  foreach $line (<FILE2>) {
	    my @lineprocs = {};
	    if ($line =~ m/\s*\d\s+(.+)$/)
	      {@lineprocs = split(/,/, $1);}
	    elsif ($line =~ m/\s*mirror\s+none\s*$/){next;}
	    elsif  ($line =~ m/\s*mirror\s+(.+)\s*$/)
	      {@lineprocs = split(/,/, $1);}
	    @processes = (@processes, @lineprocs);
	  }
	}
	$numprocs = $#processes + 1;
	print PAGE "<TD> $diagrams </TD> \n";
	print PAGE "<TD> $numprocs </TD> \n";
	print PAGE "<TD> \<A HREF=\"../SubProcesses/$line/diagrams.html\" \>html\<\/A\>";
	if ( -e "$line/matrix.ps") {
	  print PAGE " / \<A HREF=\"../SubProcesses/$line/matrix.ps\" \>postscript \<\/A\>";}
	print PAGE "\n</TD><TD>\n";
	
	foreach my $proc (0..$#processes){
	  print PAGE "<SPAN style=\"white-space: nowrap;\">$processes[$proc]";
	  if ($proc < $#processes) {print PAGE ",</SPAN>\n";}
	}
	print PAGE "</SPAN></TD> \n ";
	print PAGE "</TR>";
      }
      print PAGE "</TABLE>";
      close FILE;
      #       close(IDENT);	 
  }
    print PAGE "\<BR\> \n";
    chdir("../"); 
  } else {
    print PAGE "<H2> No diagrams were generated <\/H2> <BR> \n";
    print PAGE "Check process text and number of couplings. Also look at the log file";
    print PAGE "<BR> \n";
  }
  
  print PAGE "<CENTER> $totdiag diagrams have been generated.</CENTER>";
  open(NUMDIAG,"> ./numdiag");
  print NUMDIAG $totdiag;
  close(NUMDIAG);

  print PAGE "<TABLE ALIGN=CENTER>";
  
  print PAGE "<TR> <TD ALIGN=CENTER> <A HREF\=\"../proc_log.txt\"\>proc_log.txt<\/A\> <TD> Log file from MadGraph code generation. ";  
  if (-e "SubProcesses/procdef_mg5.dat") {
    print PAGE "<TR> <TD ALIGN=CENTER> <A HREF\=\"../Cards/proc_card_mg5.dat\"\>proc_card_mg5.dat\<\/A\> <TD> Input file used for code generation.";
  } else {
    print PAGE "<TR> <TD ALIGN=CENTER> <A HREF\=\"../Cards/proc_card.dat\"\>proc_card.dat\<\/A\> <TD> Input file used for code generation.";
  }
  print PAGE "<TR> <TD ALIGN=CENTER> <A HREF\=\"../Source/MODEL/particles.dat\"\>particles.dat\<\/A\> <TD> Particles file used for code generation.";
  print PAGE "<TR> <TD ALIGN=CENTER> <A HREF\=\"../Source/MODEL/interactions.dat\"\>interactions.dat\<\/A\> <TD> Interactions file used for code generation.";
  print PAGE "</TABLE>";
  print PAGE "\<P><H3 align=center>\<A HREF\=\"../index.html\"\> Main Page \<\/A\>";
  print PAGE "\<\/BODY\> \n";
  print PAGE "\<\/HTML\> \n";
  close(PAGE);
}				#end sub writeHtmlProcessPage
