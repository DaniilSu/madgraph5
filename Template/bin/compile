#!/bin/bash
#
################################################################################
#                                                                             ##
#                    MadGraph/MadEvent                                        ##
#                                                                             ##
# FILE : compile                                                              ##
# VERSION : 1.0                                                               ##
# DATE : 23 Septembre 2007                                                    ##
# AUTHOR : MH - MadGraph team                                                 ##
#                                                                             ##
# DESCRIPTION : script to compile madevent                                    ##
# USAGE : ./make_package                                                      ##
################################################################################

# set nonomatch

if [[ ! -d ./bin ]]; then
    cd ../
    if [[ ! -d ./bin ]]; then
        echo "Error: it must be executed from the main, or bin directory"
        exit
    fi
fi


#
# If argument is equal to 'd' use dynamic libraries
#
echo $PWD
if [[  "$1" == ""  ]]; then
    echo "Using default makefiles"
elif [[ "$1" == "dynamic" ]]; then
    echo "Changing makefiles for the generation of dynamic libraries (might not work under MacOsX)"
    export dynamic="true"
else
    echo Error: invalid argument $1
    exit
fi
if [[  "$2" == ""  ]]; then
    echo "Not using LHAPDF"
elif [[ "$1" == "lhapdf" ]]; then
    echo "Changing makefiles for using LHAPDF"
    export lhapdf="true"
else
    echo Error: invalid argument $2
    exit
fi

#
#  Now let shell know where to find important executables
#

if [[ -d Source ]]; then
    cd Source
    make ../bin/sum_html
    make ../bin/gen_ximprove
    make all
    make ../bin/combine_events
    make ../bin/combine_runs
    cd ..
else
    echo 'Error Source directory not found'
    exit
fi

if [[ -d SubProcesses ]]; then
    cd SubProcesses
    for i in `cat subproc.mg` ; do
	cd $i
	echo $i
	rm -f ajob* >& /dev/null
	rm -f wait.ajob* >& /dev/null
	rm -f run.ajob* >& /dev/null
	rm -f done.ajob* >& /dev/null
#        if [[ -e ajob1 ]]; then
#	   chmod +x ajob*
        make madevent > /dev/null
#        fi
	cd ..
     done
    cd ..
else
    echo "Error could not find SubProcesses"
    exit
fi

if [[ -d ../DECAY ]]; then
    echo "DECAY directory found, compiling..."
    cd ../DECAY
    if [[  "$1" == ""  ]]; then
	sed -i.bak "s|HELAS/lib/libdhelas3.a|madevent/lib/libdhelas3.a|g" makefile
    elif [[ "$1" == "dynamic" ]]; then
	sed -i.bak "s|HELAS/lib/libdhelas3.a|madevent/lib/libdhelas3.so|g" makefile
    else
	echo Error: invalid argument $1
	exit
    fi
    make
fi

echo ""

