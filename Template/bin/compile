#!/bin/bash
#
################################################################################
#                                                                             ##
#                    MadGraph/MadEvent                                        ##
#                                                                             ##
# FILE : compile                                                              ##
# VERSION : 1.0                                                               ##
# DATE : 23 Septembre 2007                                                    ##
# AUTHOR : MH - MadGraph team                                                 ##
#                                                                             ##
# DESCRIPTION : script to compile madevent                                    ##
# USAGE : ./make_package                                                      ##
################################################################################

# set nonomatch

if [[ ! -d ./bin ]]; then
    cd ../
    if [[ ! -d ./bin ]]; then
        echo "Error: it must be executed from the main, or bin directory"
        exit
    fi
fi


#
# If argument is equal to 'd' use dynamic libraries
#
echo $PWD
if [[ "$1" == "dynamic" ]]; then
    echo "Using dynamic libraries (might not work under MacOsX)"
    export dynamic=true
else
    echo "Using static libraries"
    unset dynamic
fi
if [[ "$2" == "lhapdf" ]]; then
    echo "Using LHAPDF libraries"
    export lhapdf=true
else
    echo "Not using LHAPDF"
    unset lhapdf
fi

#
#  Now let shell know where to find important executables
#

bin/compile_Source

if [[ -e error ]];then
   exit
fi

if [[ -d SubProcesses ]]; then
    cd SubProcesses
    for i in `cat subproc.mg` ; do
	cd $i
	echo $i
	rm -f ajob* >& /dev/null
	rm -f wait.ajob* >& /dev/null
	rm -f run.ajob* >& /dev/null
	rm -f done.ajob* >& /dev/null
#        if [[ -e ajob1 ]]; then
#	   chmod +x ajob*
        make madevent > /dev/null
	if [[ $? -ne 0 ]];then
	    # Make didn't exit successfully
	    echo Error make madevent not successful > error
	    cat error
	    exit
#        fi
	cd ..
     done
    cd ..
else
    echo "Error could not find SubProcesses"
    exit
fi

if [[ -d ../DECAY ]]; then
    echo "DECAY directory found, compiling..."
    cd ../DECAY
    if [[  "$1" == ""  ]]; then
	sed -i.bak "s|HELAS/lib/libdhelas3.a|madevent/lib/libdhelas3.a|g" makefile
    elif [[ "$1" == "dynamic" ]]; then
	sed -i.bak "s|HELAS/lib/libdhelas3.a|madevent/lib/libdhelas3.so|g" makefile
    else
	echo Error: invalid argument $1
	exit
    fi
    make
fi

echo ""

